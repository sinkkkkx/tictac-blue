<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Tic Tac Blue</title>

  <meta name="base:app_id" content="697a1c119266edba958ff4c6">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0052FF">

  <!-- Script SDK Farcaster Miniapp (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk/dist/index.min.js"></script>

  <!-- fc:miniapp untuk Preview -->
  <meta name="fc:miniapp" content='{"version":"next","imageUrl":"https://tictac-blue-eight.vercel.app/preview-1200x800.png","button":{"title":"Play Now","action":{"type":"launch_miniapp","url":"https://tictac-blue-eight.vercel.app","name":"Tic Tac Blue","splashImageUrl":"https://tictac-blue-eight.vercel.app/icon.png","splashBackgroundColor":"#000000"}}}' />
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="apple-touch-icon" href="/icon.png">

  <style>
    :root{--bg-page:#000;--card-bg:#fff;--card-border:#e1e4e8;--accent-o:#0052FF;--accent-x:#ff4757;--cell-bg:#161b22;--cell-border:#30363d;--cell-text:#c9d1d9}
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
    body{background:var(--bg-page);color:#0d1117;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .game-container{background:var(--card-bg);padding:2rem;border-radius:16px;width:100%;max-width:420px;text-align:center;border:1px solid var(--card-border);box-shadow:0 10px 40px rgba(0,0,0,.25)}
    header h1{font-size:2rem;font-weight:800;display:inline-flex;align-items:center;gap:8px}
    .blue-link{background:var(--accent-o);color:#fff;padding:4px 12px;border-radius:8px;font-weight:800;text-decoration:none}
    .subtitle{color:#666;margin-top:0.5rem;margin-bottom:1rem}
    .status-bar{margin-bottom:1rem;padding:8px 20px;border-radius:50px;border:1px solid #e1e4e8;background:rgba(0,0,0,.03)}
    .board{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:10px;margin-bottom:1rem}
    .cell{background:var(--cell-bg);color:var(--cell-text);aspect-ratio:1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:800;border:1px solid var(--card-border);cursor:pointer;user-select:none}
    .cell.o{color:var(--accent-o)} .cell.x{color:var(--accent-x)}
    .cell.will-disappear{animation:blink-red 1s infinite;border:2px solid var(--accent-x);background:#2d1518}
    @keyframes blink-red{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
    button{padding:10px 20px;border-radius:999px;border:1px solid #d0d7de;background:#f6f8fa;font-weight:700;cursor:pointer}
    .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:60}
    .modal-overlay.active{display:flex}
    .modal-content{background:#fff;padding:2rem;border-radius:16px;min-width:260px;text-align:center}
  </style>
</head>
<body>
  <main class="game-container" role="main">
    <header>
      <h1><span>Tic Tac</span> <a class="blue-link" href="https://base.app/profile/sinkkkk" target="_blank" rel="noreferrer">Blue</a></h1>
      <p class="subtitle">You (O) vs Computer (X)</p>
    </header>

    <div class="status-bar"><span id="status-text">Your Turn</span></div>
    <section id="board" class="board" aria-label="game board"></section>
    <div style="display:flex;justify-content:center"><button id="reset-btn">Reset Board</button></div>
  </main>

  <div id="result-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <h2 id="modal-title">You Win!</h2>
      <p id="modal-msg">Great moves!</p>
      <div style="margin-top:12px"><button id="rematch-btn">Rematch</button></div>
    </div>
  </div>

  <!-- GAME SCRIPT (sama seperti sebelumnya, lengkap) -->
  <script>
    const boardEl = document.getElementById('board');
    const statusText = document.getElementById('status-text');
    const resetBtn = document.getElementById('reset-btn');
    const rematchBtn = document.getElementById('rematch-btn');
    const modal = document.getElementById('result-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMsg = document.getElementById('modal-msg');

    let board = Array(9).fill('');
    let humanMoveHistory = [];
    let aiMoveHistory = [];
    let gameActive = true;
    const HUMAN = 'o', AI = 'x';
    const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

    function initGame(){
      board = Array(9).fill('');
      humanMoveHistory = []; aiMoveHistory = []; gameActive = true;
      statusText.innerText = 'Your Turn';
      modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
      boardEl.innerHTML = '';
      for(let i=0;i<9;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.addEventListener('click', ()=> handleCellClick(i));
        boardEl.appendChild(cell);
      }
      updateBlinkState();
      // SDK ready is handled separately in DOMContentLoaded
    }

    function handleCellClick(idx){
      if (!gameActive || board[idx] !== '') return;
      document.querySelectorAll('.will-disappear').forEach(el=>el.classList.remove('will-disappear'));
      makeMove(idx, HUMAN, humanMoveHistory);
      if (checkWin(board, HUMAN)){ endGame(false); return; }
      statusText.innerText = 'Computer Thinking...'; gameActive = false;
      setTimeout(()=>{
        const aiMoveObj = minimax(board, humanMoveHistory, aiMoveHistory, 0, false);
        const aiIdx = aiMoveObj.index;
        makeMove(aiIdx, AI, aiMoveHistory);
        if (checkWin(board, AI)){ endGame(false, true); }
        else { gameActive = true; statusText.innerText = 'Your Turn'; updateBlinkState(); }
      }, 500);
    }

    function makeMove(index, player, history){
      history.push(index); board[index] = player;
      const cell = boardEl.children[index];
      if (cell){ cell.innerText = player.toUpperCase(); cell.classList.add('taken', player); }
      if (history.length > 3){
        const removed = history.shift(); board[removed] = '';
        const removedCell = boardEl.children[removed];
        if (removedCell){ removedCell.innerText = ''; removedCell.classList.remove('taken','x','o'); }
      }
      updateBlinkState();
    }

    function updateBlinkState(){
      document.querySelectorAll('.will-disappear').forEach(el=>el.classList.remove('will-disappear'));
      if (gameActive && humanMoveHistory.length === 3){
        const oldest = humanMoveHistory[0]; const el = boardEl.children[oldest];
        if (el) el.classList.add('will-disappear');
      }
    }

    function checkWin(b, player){
      return wins.some(w => w.every(i => b[i] === player));
    }

    function endGame(draw, aiWins = false){
      gameActive = false; document.querySelectorAll('.will-disappear').forEach(el=>el.classList.remove('will-disappear'));
      if (draw){ modalTitle.innerText = 'Draw!'; modalMsg.innerText = 'Unbelievable.'; }
      else { if (aiWins){ modalTitle.innerText = 'You Lose'; modalMsg.innerText = 'You just proved that humans are useless :)'; }
             else { modalTitle.innerText = 'You Win!'; modalMsg.innerText = 'Great moves!'; } }
      modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
    }

    function minimax(curBoard, hHist, aHist, depth, isMaximizing){
      if (checkWin(curBoard, AI)) return { score: 10 - depth };
      if (checkWin(curBoard, HUMAN)) return { score: depth - 10 };
      if (depth >= 6) return { score: 0 };
      const avail = curBoard.map((v,i)=> v === '' ? i : null).filter(v => v !== null);
      if (avail.length === 0) return { score: 0 };
      const moves = [];
      for (let i=0;i<avail.length;i++){
        const move = { index: avail[i] }; const nb=[...curBoard]; const nh=[...hHist]; const na=[...aHist];
        if (isMaximizing){ nb[avail[i]] = AI; na.push(avail[i]); if (na.length>3){ const r=na.shift(); nb[r]=''; } move.score = minimax(nb, nh, na, depth+1, false).score; }
        else { nb[avail[i]] = HUMAN; nh.push(avail[i]); if (nh.length>3){ const r=nh.shift(); nb[r]=''; } move.score = minimax(nb, nh, na, depth+1, true).score; }
        moves.push(move);
      }
      let bestIndex=0;
      if (isMaximizing){ let bestScore=-Infinity; for (let i=0;i<moves.length;i++) if (moves[i].score>bestScore){ bestScore=moves[i].score; bestIndex=i; } }
      else { let bestScore=Infinity; for (let i=0;i<moves.length;i++) if (moves[i].score<bestScore){ bestScore=moves[i].score; bestIndex=i; } }
      return moves[bestIndex];
    }

    resetBtn.addEventListener('click', initGame);
    rematchBtn.addEventListener('click', ()=>{ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); initGame(); });

    initGame();
  </script>

  <!-- READY SCRIPT: Panggil SDK ready setelah load -->
  <script>
    // CDN build exposes SDK as window.miniapp
    // Call ready() after app is fully loaded
    window.addEventListener('DOMContentLoaded', async function() {
      try {
        // Wait a tick for miniapp SDK to be available
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (window.miniapp && window.miniapp.sdk && window.miniapp.sdk.actions) {
          await window.miniapp.sdk.actions.ready();
          console.log('[MiniApp] SDK ready called successfully via miniapp.sdk.actions.ready()');
        } else {
          console.warn('[MiniApp] miniapp.sdk not available');
        }
      } catch (e) {
        console.error('[MiniApp] Error calling SDK ready:', e);
      }
    });

    // Expose untuk manual call jika perlu
    window.notifyBaseReady = async function() {
      if (window.miniapp && window.miniapp.sdk && window.miniapp.sdk.actions) {
        await window.miniapp.sdk.actions.ready();
      }
    };
  </script>
</body>
</html>
